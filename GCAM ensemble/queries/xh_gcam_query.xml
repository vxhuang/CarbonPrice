<?xml version="1.0" encoding="UTF-8"?>
<queries>
<!-- 1. CO2 prices -->
   <aQuery>
      <region name="USA"/>
	  <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
      <marketQuery title="CO2 prices">
         <axis1 name="market">market</axis1>
         <axis2 name="Year">market</axis2>
         <xPath buildList="true" dataName="price" group="false" sumAll="false">Marketplace/market[true() and contains(@name,'CO2')]/price/node()</xPath>
         <comments/>
      </marketQuery>
   </aQuery>
<!-- 2. CO2 emissions by sector -->
   <aQuery>
      <region name="USA"/>
	  <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
      <emissionsQueryBuilder title="CO2 emissions by sector">
          <axis1 name="sector">sector</axis1>
          <axis2 name="Year">emissions</axis2>
          <xPath buildList="true" dataName="emissions" group="false" sumAll="false">*[@type='sector']//CO2/emissions/node()</xPath>
          <comments/>
       </emissionsQueryBuilder>
   </aQuery>
<!-- 3. CO2 emissions by tech -->
   <aQuery>
      <region name="USA"/>
	  <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
      <emissionsQueryBuilder title="CO2 emissions by tech">
          <axis1 name="technology">technology</axis1>
          <axis2 name="Year">emissions</axis2>
          <xPath buildList="true" dataName="emissions" group="false" sumAll="false">*[@type = 'sector' ]/*[@type='subsector']/*[@type='technology']//
          CO2/emissions/node()</xPath>
          <comments/>
       </emissionsQueryBuilder>
   </aQuery>
<!-- 4. LUC emissions by region -->
   <aQuery>
	  <region name="USA"/>
	  <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
	  <query title="LUC emissions by region">
        <axis1 name="LandLeaf">LandLeaf</axis1>
        <axis2 name="Year">land-use-change-emission[@year]</axis2>
        <xPath buildList="true" dataName="land-use-change-emission" group="false" sumAll="true"><![CDATA[/LandNode[@name='root' or @type='LandNode' (:collapse:)]//
            land-use-change-emission[@year>1970]/text()]]></xPath>
        <comments/>
     </query>
	</aQuery>
<!-- 5. GDP MER by region -->
	<aQuery>
        <region name="USA"/>
 	    <region name="Africa_Eastern"/>
        <region name="Africa_Northern"/>
        <region name="Africa_Southern"/>
        <region name="Africa_Western"/>
        <region name="Australia_NZ"/>
        <region name="Brazil"/>
        <region name="Canada"/>
        <region name="Central America and Caribbean"/>
        <region name="Central Asia"/>
        <region name="China"/>
        <region name="EU-12"/>
        <region name="EU-15"/>
        <region name="Europe_Eastern"/>
        <region name="Europe_Non_EU"/>
        <region name="European Free Trade Association"/>
        <region name="India"/>
        <region name="Indonesia"/>
        <region name="Japan"/>
        <region name="Mexico"/>
        <region name="Middle East"/>
        <region name="Pakistan"/>
        <region name="Russia"/>
        <region name="South Africa"/>
        <region name="South America_Northern"/>
        <region name="South America_Southern"/>
        <region name="South Asia"/>
        <region name="South Korea"/>
        <region name="Southeast Asia"/>
        <region name="Taiwan"/>
        <region name="Argentina"/>
        <region name="Colombia"/>	
     <gdpQueryBuilder title="GDP MER by region">
         <axis1 name="region">region</axis1>
         <axis2 name="Year">gdp-mer</axis2>
         <xPath buildList="true" dataName="gdp-mer" group="false" sumAll="false">GDP/gdp-mer/text()</xPath>
         <comments/>
      </gdpQueryBuilder>
    </aQuery>
<!-- 6. global mean temperature -->
   <aQuery>
        <region name="USA"/>
 	    <region name="Africa_Eastern"/>
        <region name="Africa_Northern"/>
        <region name="Africa_Southern"/>
        <region name="Africa_Western"/>
        <region name="Australia_NZ"/>
        <region name="Brazil"/>
        <region name="Canada"/>
        <region name="Central America and Caribbean"/>
        <region name="Central Asia"/>
        <region name="China"/>
        <region name="EU-12"/>
        <region name="EU-15"/>
        <region name="Europe_Eastern"/>
        <region name="Europe_Non_EU"/>
        <region name="European Free Trade Association"/>
        <region name="India"/>
        <region name="Indonesia"/>
        <region name="Japan"/>
        <region name="Mexico"/>
        <region name="Middle East"/>
        <region name="Pakistan"/>
        <region name="Russia"/>
        <region name="South Africa"/>
        <region name="South America_Northern"/>
        <region name="South America_Southern"/>
        <region name="South Asia"/>
        <region name="South Korea"/>
        <region name="Southeast Asia"/>
        <region name="Taiwan"/>
        <region name="Argentina"/>
        <region name="Colombia"/>
           <ClimateQuery title="global mean temperature">
            <axis1 name="temperature">none</axis1>
            <axis2 name="Year">global-mean-temperature[@year]</axis2>
            <xPath buildList="true" dataName="global-mean-temperature" group="false" sumAll="false">climate-model/global-mean-temperature/text()</xPath>
            <comments/>
         </ClimateQuery>
	  </aQuery>
<!-- 7. total climate forcing -->
   <aQuery>
	  <region name="USA"/>
	  <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
	  <ClimateQuery title="total climate forcing">
        <axis1 name="forcing-total">none</axis1>
        <axis2 name="Year">forcing-total[@year]</axis2>
        <xPath buildList="true" dataName="forcing-total" group="false" sumAll="false">climate-model/forcing-total/text()</xPath>
        <comments/>
     </ClimateQuery>
	</aQuery>
<!-- 8. CO2 concentrations -->
   <aQuery>
	  <region name="USA"/>
	  <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
    	  <ClimateQuery title="CO2 concentrations">
            <axis1 name="CO2-concentration">none</axis1>
            <axis2 name="Year">CO2-concentration[@year]</axis2>
            <xPath buildList="true" dataName="CO2-concentration" group="false" sumAll="false">climate-model/CO2-concentration/text()</xPath>
            <comments/>
         </ClimateQuery>
	</aQuery>
<!-- 9. nonCO2 emissions by sector -->
	<aQuery>
    	  <region name="USA"/>
    	  <region name="Africa_Eastern"/>
          <region name="Africa_Northern"/>
          <region name="Africa_Southern"/>
          <region name="Africa_Western"/>
          <region name="Australia_NZ"/>
          <region name="Brazil"/>
          <region name="Canada"/>
          <region name="Central America and Caribbean"/>
          <region name="Central Asia"/>
          <region name="China"/>
          <region name="EU-12"/>
          <region name="EU-15"/>
          <region name="Europe_Eastern"/>
          <region name="Europe_Non_EU"/>
          <region name="European Free Trade Association"/>
          <region name="India"/>
          <region name="Indonesia"/>
          <region name="Japan"/>
          <region name="Mexico"/>
          <region name="Middle East"/>
          <region name="Pakistan"/>
          <region name="Russia"/>
          <region name="South Africa"/>
          <region name="South America_Northern"/>
          <region name="South America_Southern"/>
          <region name="South Asia"/>
          <region name="South Korea"/>
          <region name="Southeast Asia"/>
          <region name="Taiwan"/>
          <region name="Argentina"/>
          <region name="Colombia"/>
         <emissionsQueryBuilder title="nonCO2 emissions by sector">
            <axis1 name="GHG">GHG</axis1>
            <axis2 name="Year">emissions</axis2>
            <xPath buildList="true" dataName="emissions" group="false" sumAll="false">*[@type = 'sector']//*[@type = 'GHG']/emissions/node()</xPath>
            <comments/>
         </emissionsQueryBuilder>
         </aQuery>
<!-- 10. nonCO2 emissions by tech -->
    <aQuery>
	  <region name="USA"/>
	  <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <emissionsQueryBuilder title="nonCO2 emissions by tech">
            <axis1 name="GHG">GHG</axis1>
            <axis2 name="Year">emissions</axis2>
            <xPath buildList="true" dataName="emissions" group="false" sumAll="false">*[@type = 'sector']/*[@type = 'subsector']/*[@type = 'technology']/
            *[@type = 'GHG']/emissions/node()</xPath>
            <comments/>
         </emissionsQueryBuilder>
    </aQuery>
<!-- 11. population by region -->
   <aQuery>
     <region name="USA" />
     <region name="Canada"/>         
     <region name="Africa_Eastern"/>      
     <region name="Africa_Northern"/>     
     <region name="Africa_Southern"/>
     <region name="Africa_Western"/>
     <region name="Japan"/>
     <region name="South Korea"/>
     <region name="China"/>
     <region name="India"/>
     <region name="Brazil"/>
     <region name="Central America and Caribbean"/>
     <region name="Central Asia"/>
     <region name="EU-12"/>    
     <region name="EU-15"/>
     <region name="Europe_Eastern"/>
     <region name="Europe_Non_EU"/>
     <region name="European Free Trade Association"/>
     <region name="Indonesia"/>
     <region name="Mexico"/>
     <region name="Middle East"/>
     <region name="Pakistan"/>
     <region name="Russia"/>
     <region name="South Africa"/>
     <region name="South America_Northern"/>
     <region name="South America_Southern"/>
     <region name="South Asia"/>
     <region name="Southeast Asia"/>
     <region name="Taiwan"/>
     <region name="Argentina"/>
     <region name="Colombia"/>
     <region name="Australia_NZ"/>
   	<demographicsQuery title="population by region">
         <axis1 name="region">region</axis1>
         <axis2 name="Year">populationMiniCAM</axis2>
         <xPath buildList="true" dataName="total-population" group="false" sumAll="false">demographics/populationMiniCAM/total-population/node()</xPath>
         <comments/>
      </demographicsQuery>
   </aQuery>
<!-- 12. primary energy consumption with CCS by region (direct equivalent) -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="primary energy consumption with CCS by region (direct equivalent)">
            <axis1 name="fuel">input[@name]</axis1>
            <axis2 name="Year">demand-physical[@vintage]</axis2>
            <xPath buildList="true" dataName="input" group="false" sumAll="false"> <![CDATA[
               declare function local:append-heirarchy($parent as node(), $append as node()*) as node() {
               let $scn := $parent/ancestor::scenario,
                    $rgn := $parent (: /ancestor::region :)
                 return
                    document { element scenario {
                            $scn/@*,
                          element region {
                            $rgn/@*,
                            $append
                          }
                          }
                }
               (: I can get by with just the scenario and region
               let $new_node := element {local-name($parent)} {$parent/@*, $append}   
               return
               if(local-name($parent) != 'scenario')
               then local:append-heirarchy($parent/parent::*, $new_node)
               else document { $new_node } :)
             }; 
             declare function local:generate-sector-input-coefs($outputNameQueue as xs:string*, $currTree as node(), $coefs as node()*, $is_usa as xs:boolean) as node()* {
                 if(empty($outputNameQueue)) then $coefs
                 else if( exists($coefs[@name = $outputNameQueue[1]]) or exists(index-of(('biomass',
'traded unconventional oil', 'regional corn for ethanol', 'regional biomassOil', 'regional sugar for ethanol', 'regional sugarbeet for ethanol'),
$outputNameQueue[1])) or not($currTree/*[@type='sector' and @name=$outputNameQueue[1]]))
then 
(:if(not($is_usa) and string-length($currTree/@name) = 2) then
local:trace-inputs($outputName, $currTree/parent::*/*[@type='region' and @name='USA'], $outputs, true())
else:)
local:generate-sector-input-coefs(remove($outputNameQueue, 1), $currTree, $coefs, $is_usa)
                else
                    let $outputName := $outputNameQueue[1],
                        $newOutputNameQueue := remove($outputNameQueue, 1),
                        $useOutputs := $currTree//output-primary[@type='output' and @name=$outputName],
                        $useInputs := for $out in $useOutputs[not(following-sibling::keyword[exists(@primary-renewable)])]
                                      return $out/following-sibling::*[@type='input' and not(@name='oil-credits')],
                        $renewOutputs := for $out in $useOutputs[following-sibling::keyword[exists(@primary-renewable)]]
                                         return element output {
                                             attribute name { $out/following-sibling::keyword/@primary-renewable },
                                             $out/child::*
                                         },
                        $totalOutputSum := for $vintage in distinct-values($useOutputs/physical-output/@vintage)
                                          return element output {
                                                     attribute vintage { $vintage },
                                                     text {
                                                         sum($useOutputs/physical-output[@vintage=$vintage])
                                                     }
                                                 },
                       $new_coefs := $coefs | element sector {
                                            attribute name { $outputName },
                                            for $input in distinct-values($useInputs/@name)
                                            return element input {
                                                       attribute name { $input },
                                                       for $outputSum in $totalOutputSum
                                                       let $inputSum := sum($useInputs[@name=$input]/demand-physical[@vintage=$outputSum/@vintage])
                                                       where $inputSum > 0
                                                       return element coef {
                                                                  attribute vintage { $outputSum/@vintage },
                                                                  text { $inputSum div $outputSum }
                                                              }
                                                    },
                                            for $input in distinct-values($renewOutputs/@name)
                                            return element input {
                                                       attribute name { concat($input, ' renewable') },
                                                       attribute is-renewable { true() },
                                                       for $outputSum in $totalOutputSum
                                                       let $inputSum := sum($renewOutputs[@name=$input]/physical-output[@vintage=$outputSum/@vintage])
                                                       where $inputSum > 0
                                                       return element coef {
                                                                  attribute vintage { $outputSum/@vintage },
                                                                  text { $inputSum div $outputSum }
                                                              }
                                                    }
                                        }
                        return 
                              local:generate-sector-input-coefs(distinct-values(($newOutputNameQueue, $useInputs/@name)), $currTree, $new_coefs, $is_usa)
    };
        declare function local:generate-ccs-coefs($currTree as node(), $coefs as node()*) as node()* {
            for $sector in $coefs/@name
            let $currSector := $currTree/*[@type='sector' and @name=$sector],
                $useInputs := $currSector//*[@type='technology' and not(contains(@name, 'CCS')) and not(child::keyword/@primary-renewable)]/*[@type='input' and not(@name='oil-credits')],
                $useInputsCCS := $currSector//*[@type='technology' and contains(@name, 'CCS')]/*[@type='input' and not(@name='oil-credits')],
                $totalOutputSum := for $vintage in distinct-values($useInputs/demand-physical/@vintage | $useInputsCCS/demand-physical/@vintage)
                                          return element output {
                                                     attribute vintage { $vintage },
                                                     text {
                                                         sum($currSector//output-primary/physical-output[@vintage=$vintage])
                                                     }
                                                 }
            return if(exists($useInputsCCS)) then
                element sector {
                                            attribute name { $sector },
                                            $coefs[@name=$sector]/input[@is-renewable],
                                            for $input in distinct-values(($useInputs/@name, $useInputsCCS/@name))
                                            return element input {
                                                       attribute name { $input },
                                                       for $outputSum in $totalOutputSum
                                                       let $inputSum := sum($useInputs[@name=$input]/demand-physical[@vintage=$outputSum/@vintage]),
                                                           $inputSumCCS := sum($useInputsCCS[@name=$input]/demand-physical[@vintage=$outputSum/@vintage])
                                                       return (element coef {
                                                                  attribute vintage { $outputSum/@vintage },
                                                                  text { $inputSum div $outputSum }
                                                              },
                                                              element coef_ccs {
                                                                  attribute vintage { $outputSum/@vintage },
                                                                  text { $inputSumCCS div $outputSum }
                                                              })
                                                    }
                                        }
                    else
                        $coefs[@name=$sector]
        };
        declare function local:apply-coefs($outputName as xs:string, $outputs as node()*, $coefs as node()*, $isCCS as xs:boolean) as node()* {
            if(exists($coefs[@name=$outputName]) and sum($outputs) > 0.001) then
                for $input in $coefs[@name=$outputName]/input
                return local:apply-coefs($input/@name,
                    for $vintage in distinct-values($outputs/@vintage)
                    let $outputThisVintage := $outputs[@vintage=$vintage],
                        $firstOutput := $outputThisVintage[1],
                        $outputSum := sum($outputThisVintage),
                        $coefThisVintage := $input/coef[@vintage=$vintage]
                    where $coefThisVintage > 0
                return element { local-name($firstOutput) } {
                $firstOutput/@*,
                        text{ $outputSum * $coefThisVintage }
                        }, $coefs, $isCCS)
                    | local:apply-coefs($input/@name,
                    for $vintage in distinct-values($outputs/@vintage)
                    let $outputThisVintage := $outputs[@vintage=$vintage],
                        $firstOutput := $outputThisVintage[1],
                        $outputSum := sum($outputThisVintage),
                        $coefThisVintage := $input/coef_ccs[@vintage=$vintage]
                    where exists($coefThisVintage) and $coefThisVintage > 0
                return element { local-name($firstOutput) } {
                $firstOutput/@*,
                        text{ $outputSum * $coefThisVintage }
              }, $coefs, true())
            else if( sum($outputs) > 0.001) then
                element input {
                    attribute name { if($isCCS) then concat($outputName, ' CCS') else $outputName },
                    attribute type { 'input' },
                    (: $outputs :) (: TODO: not sure why this doesn't work and we need to create these explicitly :)
                    for $o in $outputs
                    return element demand-physical { $o/@*, text{ $o/text() } }
                }
            else
                (: These are the residuals from chasing simulenaties, I've left this here
                   for debuging purposes :)
                element input {
                    attribute name { $outputName },
                    attribute type { 'input' } (:,
                    $outputs :)
                }
        };
    declare function local:run-input-by-primary($scenarios as xs:string*, $regions as xs:string*, $collection as xs:string) as node()* {  
         unordered {  
         let $regionsG := if(not($regions[1] = 'Global'))
              then $regions
              else distinct-values(collection($collection)/scenario/world/*[@type='region']/@name)
         return
         for $scenario in $scenarios,       
         $region in $regionsG   
         let $scenario_split := tokenize($scenario, ' '),       
         $currTree := collection($collection)/scenario[@name = $scenario_split[1] and @date = $scenario_split[2]]/world/*[@type='region' and @name=$region],
                 $currInputs := $currTree/*[@type='sector' and (@name='unconventional oil production' or exists(child::keyword/@final-energy))]//*[@type='input' and empty(index-of(('trn_pass_road', 'limestone', 'process heat cement', 'industrial energy use', 'industrial feedstocks', 'renewable', 'trn_freight_road', 'trn_pass_road_LDV', 'trn_pass_road_LDV_2W', 'trn_pass_road_LDV_4W', 'unconventional oil', 'oil-credits'), @name))],
                 $coefs := local:generate-sector-input-coefs(distinct-values($currInputs/@name), $currTree, (), false()),
                 $ccs_coefs := local:generate-ccs-coefs($currTree, $coefs)
         return 
            for $inputName in distinct-values($currInputs/@name)
            return local:append-heirarchy($currTree, local:apply-coefs($inputName, $currInputs[@name=$inputName]/demand-physical, $ccs_coefs, false()))//text()
         } 
     };
     local:run-input-by-primary((:scenarios:), (:regions:), (:collection:))
         ]]>
         </xPath>
            <comments>WARNING: Results are slightly inflated due to improper secondary-output accounting</comments>
            <labelRewriteList append-values="false">
               <level name="input">
                  <rewrite from="limestone" to=""/>
                  <rewrite from="wind-H2 renewable" to="g wind"/>
                  <rewrite from="geothermal-elect" to="i geothermal"/>
                  <rewrite from="regional sugarbeet for ethanol" to="d biomass"/>
                  <rewrite from="biomass" to="d biomass"/>
                  <rewrite from="traded biomass" to="d biomass"/>
                  <rewrite from="traded biomass CCS" to="d biomass CCS"/>
                  <rewrite from="nuclear-elect renewable" to="e nuclear"/>
                  <rewrite from="natural gas" to="b natural gas"/>
                  <rewrite from="exotic-elect" to="j breakthrough"/>
                  <rewrite from="wind-elect" to="g wind"/>
                  <rewrite from="elect_td_ind" to=""/>
                  <rewrite from="hydro-elect renewable" to="f hydro"/>
                  <rewrite from="solar-H2 renewable" to="h solar"/>
                  <rewrite from="regional biomassOil CCS" to="d biomass CCS"/>
                  <rewrite from="regional natural gas" to=""/>
                  <rewrite from="regional sugar for ethanol CCS" to="d biomass CCS"/>
                  <rewrite from="coal CCS" to="c coal CCS"/>
                  <rewrite from="coal" to="c coal"/>
                  <rewrite from="crude oil" to="a oil"/>
                  <rewrite from="natural gas CCS" to="b natural gas CCS"/>
                  <rewrite from="crude oil CCS" to="a oil CCS"/>
                  <rewrite from="traded unconventional oil" to="a oil"/>
                  <rewrite from="geothermal-elect renewable" to="i geothermal"/>
                  <rewrite from="geothermal-elect renewable CCS" to="i geothermal"/>
                  <rewrite from="traditional biomass" to="j traditional biomass"/>
                  <rewrite from="regional sugar for ethanol" to="d biomass"/>
                  <rewrite from="biomass CCS" to="d biomass CCS"/>
                  <rewrite from="nuclear-elect renewable CCS" to="e nuclear"/>
                  <rewrite from="renewable" to=""/>
                  <rewrite from="regional corn for ethanol" to="d biomass"/>
                  <rewrite from="regional corn for ethanol CCS" to="d biomass CCS"/>
                  <rewrite from="wind-elect renewable" to="g wind"/>
                  <rewrite from="regional biomassOil" to="d biomass"/>
                  <rewrite from="wind-elect renewable CCS" to="g wind"/>
                  <rewrite from="nuclear-H2 renewable" to="e nuclear"/>
                  <rewrite from="hydro-elect renewable CCS" to="f hydro"/>
                  <rewrite from="solar-elect renewable" to="h solar"/>
                  <rewrite from="solar-elect renewable CCS" to="h solar"/>
                  <rewrite from="traded unconventional oil CCS" to="a oil CCS"/>
                  <rewrite from="seawater" to=""/>
                  <rewrite from="water consumption" to=""/>
                  <rewrite from="water withdrawals" to=""/>
                  <rewrite from="seawater CCS" to=""/>
                  <rewrite from="water consumption CCS" to=""/>
                  <rewrite from="water withdrawals CCS" to=""/>
               </level>
            </labelRewriteList>
         </supplyDemandQuery>
    </aQuery>
    <!-- 13. final energy consumption by sector and fuel -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="final energy consumption by sector and fuel">
            <axis1 name="input">input</axis1>
            <axis2 name="Year">demand-physical[@vintage]</axis2>
            <xPath buildList="true" dataName="input" group="false" sumAll="false">*[@type='sector' and ((@name='building' or @name='industry' or @name='transportation') or
            (exists(child::keyword/@final-energy)))]//*[@type='input' and
            not(@name='limestone' or @name='process heat cement' or @name='industrial energy use' or
                @name='industrial feedstocks' or @name='renewable' or contains(@name, 'trn_') or @name='oil-credits')]/
            demand-physical[@unit='EJ']/node()</xPath>
            <comments/>
            <labelRewriteList append-values="false">
               <level name="input">
                  <rewrite from="delivered biomass" to="biomass"/>
                  <rewrite from="elect_td_bld" to="electricity"/>
                  <rewrite from="refined liquids enduse" to="refined liquids"/>
                  <rewrite from="H2 enduse" to="hydrogen"/>
                  <rewrite from="delivered coal" to="coal"/>
                  <rewrite from="elect_td_trn" to="electricity"/>
                  <rewrite from="elect_td_ind" to="electricity"/>
                  <rewrite from="delivered gas" to="gas"/>
                  <rewrite from="wholesale gas" to="gas"/>
                  <rewrite from="refined liquids industrial" to="refined liquids"/>
                  <rewrite from="regional coal" to="coal"/>
                  <rewrite from="regional biomass" to="biomass"/>
               </level>
            </labelRewriteList>
         </supplyDemandQuery>
    </aQuery>
    <!-- 14. elec gen by gen tech -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="elec gen by gen tech">
               <axis1 name="technology">technology</axis1>
               <axis2 name="Year">physical-output[@vintage]</axis2>
               <xPath buildList="true" dataName="output" group="false" sumAll="false">*[@type='sector' (:collapse:) and
               (@name='electricity' or @name='elect_td_bld' or @name='industrial energy use')]/
               *[@type='subsector']/*[@type='technology' and not (@name='electricity' or @name='elect_td_bld')]/
               *[@type='output' and (@name='electricity' or @name='elect_td_bld')]/
               physical-output/node()</xPath>
               <comments/>
            </supplyDemandQuery>
    </aQuery>
    <!-- 15. elec gen by gen tech and cooling tech and vintage -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="elec gen by gen tech and cooling tech and vintage">
               <axis1 name="technology">technology</axis1>
               <axis2 name="Year">physical-output[@vintage]</axis2>
               <xPath buildList="true" dataName="output" group="false" sumAll="false">*[@type='sector' and (@name='electricity' or @name='elect_td_bld' or
                  contains(@name,'elec_')) and not(contains(@name, 'water_td'))]/
                  *[@type='subsector' and not (@name='elect_td_bld')]/
                  *[@type='technology' and not(@name='biomass (conv)' or @name='biomass (conv CCS)' or @name='biomass (IGCC)' or @name='biomass (IGCC CCS)'
                                   or @name='coal (conv pul)' or @name='coal (conv pul CCS)' or @name='coal (IGCC)' or @name='coal (IGCC CCS)'
                                   or @name='gas (steam/CT)' or @name='gas (CC)' or @name='gas (CC CCS)'
                                   or @name='refined liquids (steam/CT)' or @name='refined liquids (CC)' or @name='refined liquids (CC CCS)'
                                   or @name='geothermal' or @name='Gen_II_LWR' or @name='Gen_III'
                                   or @name='CSP' or @name='CSP_storage')]/
                  *[@type='output']/physical-output/node()
               </xPath>
               <comments/>
               <labelRewriteList append-values="false">
                  <level name="sector">
                     <rewrite from="elec_gas (CC CCS)" to="electricity"/>
                     <rewrite from="elec_coal (conv pul)" to="electricity"/>
                     <rewrite from="elec_biomass (IGCC CCS)" to="electricity"/>
                     <rewrite from="elec_coal (IGCC CCS)" to="electricity"/>
                     <rewrite from="elec_gas (CC)" to="electricity"/>
                     <rewrite from="elec_coal (conv pul CCS)" to="electricity"/>
                     <rewrite from="elec_CSP" to="electricity"/>
                     <rewrite from="elec_Gen_II_LWR" to="electricity"/>
                     <rewrite from="elec_refined liquids (steam/CT)" to="electricity"/>
                     <rewrite from="elec_refined liquids (CC)" to="electricity"/>
                     <rewrite from="elec_Gen_III" to="electricity"/>
                     <rewrite from="elec_geothermal" to="electricity"/>
                     <rewrite from="elec_refined liquids (CC CCS)" to="electricity"/>
                     <rewrite from="elec_biomass (conv)" to="electricity"/>
                     <rewrite from="elec_gas (steam/CT)" to="electricity"/>
                     <rewrite from="elec_biomass (conv CCS)" to="electricity"/>
                     <rewrite from="elec_biomass (IGCC)" to="electricity"/>
                     <rewrite from="elec_coal (IGCC)" to="electricity"/>
                     <rewrite from="elec_CSP_storage" to="electricity"/>
                  </level>
                  <level name="subsector">
                     <rewrite from="biomass (IGCC CCS)" to="biomass"/>
                     <rewrite from="biomass (IGCC)" to="biomass"/>
                     <rewrite from="coal (IGCC CCS)" to="coal"/>
                     <rewrite from="CSP" to="solar"/>
                     <rewrite from="Gen_III" to="nuclear"/>
                     <rewrite from="refined liquids (CC CCS)" to="refined liquids"/>
                     <rewrite from="gas (CC)" to="gas"/>
                     <rewrite from="Gen_II_LWR" to="nuclear"/>
                     <rewrite from="coal (conv pul CCS)" to="coal"/>
                     <rewrite from="biomass (conv)" to="biomass"/>
                     <rewrite from="gas (steam/CT)" to="gas"/>
                     <rewrite from="coal (conv pul)" to="coal"/>
                     <rewrite from="gas (CC CCS)" to="gas"/>
                     <rewrite from="refined liquids (CC)" to="refined liquids"/>
                     <rewrite from="coal (IGCC)" to="coal"/>
                     <rewrite from="biomass (conv CCS)" to="biomass"/>
                     <rewrite from="CSP_storage" to="solar"/>
                     <rewrite from="refined liquids (steam/CT)" to="refined liquids"/>
                  </level>
               </labelRewriteList>
               <showAttribute attribute-name="year" level="technology"/>
            </supplyDemandQuery>
    </aQuery>
    <!-- 16. building final energy by service and fuel -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="building final energy by service and fuel">
               <axis1 name="sector">sector</axis1>
               <axis2 name="Year">demand-physical[@vintage]</axis2>
               <xPath buildList="true" dataName="input" group="false" sumAll="false">*[@type='sector' and (@name='building' or (exists(child::keyword[@final-energy='building'])))]//
               *[@type='input']/demand-physical/node()</xPath>
               <comments/>
            </supplyDemandQuery>
    </aQuery>
    <!-- 17. industry final energy by service and fuel -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="industry final energy by service and fuel">
               <axis1 name="input">input</axis1>
               <axis2 name="Year">demand-physical[@vintage]</axis2>
               <xPath buildList="true" dataName="input" group="false" sumAll="false">*[@type='sector' and (@name='industry' or (exists(child::keyword[@final-energy='industry'])))]//
               *[@type='input' and (@name='delivered biomass' or @name='delivered coal' or
               @name='H2 enduse' or @name='elect_td_ind' or @name='wholesale gas' or
               @name='refined liquids industrial')]/demand-physical/node()</xPath>
               <comments>process heat cement assigned to cement</comments>
               <labelRewriteList append-values="false">
                  <level name="sector">
                     <rewrite from="process heat cement" to="cement"/>
                  </level>
               </labelRewriteList>
            </supplyDemandQuery>
    </aQuery>
    <!-- 18. transport final energy by mode and fuel -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="transport final energy by mode and fuel">
               <axis1 name="mode">subsector</axis1>
               <axis2 name="Year">demand-physical[@vintage]</axis2>
               <xPath buildList="true" dataName="input" group="false" sumAll="false">*[@type='sector' and (@name='transportation' or (exists(child::keyword[@final-energy='transportation'])))]/
               *[@type='subsector']//*[@type='input' and not (@name='renewable')]/
               demand-physical[@unit='EJ']/node()</xPath>
               <comments/>
            </supplyDemandQuery>
    </aQuery>
    <!-- 19. food consumption by type (specific) -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="food consumption by type (specific)">
            <axis1 name="technology">technology</axis1>
            <axis2 name="Year">physical-output[@vintage]</axis2>
            <xPath buildList="true" dataName="output" group="false" sumAll="false">*[@type='sector' and (@name='FoodDemand_Crops' or @name='FoodDemand_Meat')]/
            *[@type='subsector']/*[@type='technology']/
            *[@type='output']/physical-output/node()</xPath>
            <comments/>
         </supplyDemandQuery>
    </aQuery>
    <!-- 20. ag production by crop type -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="ag production by crop type">
            <axis1 name="sector">sector[@name]</axis1>
            <axis2 name="Year">physical-output[@vintage]</axis2>
            <xPath buildList="true" dataName="output" group="false" sumAll="false">*[@type='sector' and (local-name()='AgSupplySector')]//
            output-primary/physical-output/node()</xPath>
            <comments>primary output only (no residue biomass)</comments>
         </supplyDemandQuery>
    </aQuery>
    <!-- 21. meat and dairy production by type -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="meat and dairy production by type">
               <axis1 name="sector">sector</axis1>
               <axis2 name="Year">physical-output[@vintage]</axis2>
               <xPath buildList="true" dataName="output" group="false" sumAll="false">*[@type='sector' and
               (@name='Beef' or @name='SheepGoat' or @name='Pork' or @name='Dairy' or @name='Poultry')]//
               *[@type='output']/physical-output/node()</xPath>
               <comments/>
            </supplyDemandQuery>
    </aQuery>
    <!-- 22. prices by sector -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="prices by sector">
            <axis1 name="sector">sector</axis1>
            <axis2 name="Year">cost</axis2>
            <xPath buildList="true" dataName="Price" group="false" sumAll="false">*[@type = 'sector']/cost/text()</xPath>
            <comments/>
         </supplyDemandQuery>
    </aQuery>
    <!-- 23. costs by tech -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="costs by tech">
            <axis1 name="technology">technology</axis1>
            <axis2 name="Year">technology</axis2>
            <xPath buildList="true" dataName="cost" group="false" sumAll="false">*[@type='sector' and (local-name()!='AgSupplySector')]/*[@type = 'subsector']/*[@type = 'technology']/cost/text()</xPath>
            <comments>Excludes AgProductionTechnology costs, where data written out are no meaningful</comments>
         </supplyDemandQuery>
    </aQuery>
    <!-- 24. CO2 sequestration by tech -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <emissionsQueryBuilder title="CO2 sequestration by tech">
            <axis1 name="subsector">subsector</axis1>
            <axis2 name="Year">emissions-sequestered</axis2>
            <xPath buildList="true" dataName="emissions" group="false" sumAll="false">*[@type = 'sector' ]/*[@type='subsector']/*[@type='technology']//
            CO2/emissions-sequestered/node()</xPath>
            <comments/>
         </emissionsQueryBuilder>
    </aQuery>
    <!-- 25. water withdrawals by tech -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="water withdrawals by tech">
         <axis1 name="technology">technology</axis1>
         <axis2 name="Year">demand-physical[@vintage]</axis2>
         <xPath buildList="true" dataName="input" group="false" sumAll="false">*[@type='sector']/*[@type='subsector']/*[@type='technology']/*[@type='input' (:collapse:)
         and contains(@name,'water_td') and ends-with(@name,'_W')]/demand-physical/node()</xPath>
         <comments/>
         <labelRewriteList append-values="false">
            <level name="sector">
               <rewrite from="elec_coal (conv pul)" to="electricity"/>
               <rewrite from="elec_gas (CC)" to="electricity"/>
               <rewrite from="elec_CSP" to="electricity"/>
               <rewrite from="elec_Gen_II_LWR" to="electricity"/>
               <rewrite from="elec_refined liquids (CC)" to="electricity"/>
               <rewrite from="elec_refined liquids (steam/CT)" to="electricity"/>
               <rewrite from="elec_Gen_III" to="electricity"/>
               <rewrite from="elec_geothermal" to="electricity"/>
               <rewrite from="elec_biomass (conv)" to="electricity"/>
               <rewrite from="elec_gas (steam/CT)" to="electricity"/>
               <rewrite from="elec_biomass (IGCC)" to="electricity"/>
               <rewrite from="elec_coal (IGCC)" to="electricity"/>
               <rewrite from="elec_CSP_storage" to="electricity"/>
            </level>
         </labelRewriteList>
      </supplyDemandQuery>
    </aQuery>
    <!-- 26. water consumption by tech -->
    <aQuery>
    <region name="USA"/>
    <region name="Africa_Eastern"/>
      <region name="Africa_Northern"/>
      <region name="Africa_Southern"/>
      <region name="Africa_Western"/>
      <region name="Australia_NZ"/>
      <region name="Brazil"/>
      <region name="Canada"/>
      <region name="Central America and Caribbean"/>
      <region name="Central Asia"/>
      <region name="China"/>
      <region name="EU-12"/>
      <region name="EU-15"/>
      <region name="Europe_Eastern"/>
      <region name="Europe_Non_EU"/>
      <region name="European Free Trade Association"/>
      <region name="India"/>
      <region name="Indonesia"/>
      <region name="Japan"/>
      <region name="Mexico"/>
      <region name="Middle East"/>
      <region name="Pakistan"/>
      <region name="Russia"/>
      <region name="South Africa"/>
      <region name="South America_Northern"/>
      <region name="South America_Southern"/>
      <region name="South Asia"/>
      <region name="South Korea"/>
      <region name="Southeast Asia"/>
      <region name="Taiwan"/>
      <region name="Argentina"/>
      <region name="Colombia"/>
        <supplyDemandQuery title="water consumption by tech">
         <axis1 name="technology">technology</axis1>
         <axis2 name="Year">demand-physical[@vintage]</axis2>
         <xPath buildList="true" dataName="input" group="false" sumAll="false">*[@type='sector']/*[@type='subsector']/*[@type='technology']/*[@type='input' (:collapse:)
         and contains(@name,'water_td') and ends-with(@name,'_C')]/demand-physical/node()</xPath>
         <comments/>
         <labelRewriteList append-values="false">
            <level name="sector">
               <rewrite from="elec_coal (conv pul)" to="electricity"/>
               <rewrite from="elec_gas (CC)" to="electricity"/>
               <rewrite from="elec_CSP" to="electricity"/>
               <rewrite from="elec_Gen_II_LWR" to="electricity"/>
               <rewrite from="elec_refined liquids (CC)" to="electricity"/>
               <rewrite from="elec_refined liquids (steam/CT)" to="electricity"/>
               <rewrite from="elec_Gen_III" to="electricity"/>
               <rewrite from="elec_geothermal" to="electricity"/>
               <rewrite from="elec_biomass (conv)" to="electricity"/>
               <rewrite from="elec_gas (steam/CT)" to="electricity"/>
               <rewrite from="elec_biomass (IGCC)" to="electricity"/>
               <rewrite from="elec_coal (IGCC)" to="electricity"/>
               <rewrite from="elec_CSP_storage" to="electricity"/>
            </level>
         </labelRewriteList>
      </supplyDemandQuery>
    </aQuery>

</queries>
    